# Theoretical Background

my idea was to group all theoretics into one chapter, like a when the information becomes necessary during the quarto book, people can just jump back to this. we would circumvent having to introduce every little concept seperately whenever it comes up...

:::{.callout-warning}
I am thinking about changing the order, so that we are starting with biquads and work through the filter design from big to small...
:::

This chapter introduces the theory and core concepts necessary for IC design of a biquad filter. It is structured in a way, that it goes from the big picture to the small components. First, biquad filters are introduced with a focus on the universal biquad filter. After that, operational amplifiers come into the the foreground, as biquad filters make use of them in their circuits. Operational amplifiers are looked upon from an IC design standpoint.

## Biquad filter

The biquadratic filter, also known as the biquad filter, has its earliest implementation in the 1960s but is still in use today, most commonly in radio frequency receivers [@razavi2018]. In its application in RF-technology, it is used to remove unwanted neighboring signals ans noise [@razavi2024]. As biquad filter are second-order filters, they are also used as building blocks for higher filter implementations, by cascading them and adding first order filters [@aslkpro2012].

### Universal biquad filter

For the filter design in this project, an universal biquad filter is used. The universal biquad filter is biquad filter variant with four operational amplifiers used in its design and the property of being able to be used in four different filter variants. Depending on the output of the universal biquad used, a low pass filter, high pass filter, band pass filter, or band stop filter will be implemented. This can be seen in (ref to figure of biquad fitler design). [@aslkpro2012]

![circuit design of an universal biquad filter](/images/sec_theorectical_background/biquad_circuit.pdf){#fig-BiquadCircuit width=100%}

NOTE: change to png

The universal biquad filter consists of two non-inverting amplifiers working as adders in the circuit and two integrators. By setting $R$ and $C$ to specific values, the resonance frequency can be chosen. Other parameters adjustable in the universal biquad filter are the quality factor $Q$ and the low-frequency gain $H_0$. The quality factor and low-frequency gain determine the frequency response peaks of the low pass filter and the band pass filter. [@aslkpro2012]

### Characteristics

NOTE: no more than 3 subsections!

As the universal biquad filter is a second order filter with the specified outputs low pass, high pass, band pass, and band stop, each filter option can be described with a tranfer function on system level. The general second order transfer function is:

$$
H(s) = \frac{a_1 s^2 + b_1 s + c_1}{a_2 s^2 + b_2 s + c_2}
$$ {#eq-TFSecondOrder}

The coeffcients can be choosen so, that different responses, like low pass, high pass, band pass, and band stop are achieved.

In filter design a variant of this generalized transfer function is often choosen because it is easier describe the system by quality factor and angular frequency. @eq-TFSecondOrderBiquad is an exemplatory low pass filter with a transfer function specified for filter design. [@razavi2018]

$$
H(s) = \frac{\omega_n^2}{s^2 + \frac{\omega_n}{Q} s + \omega_n^2}
$$ {#eq-TFSecondOrderBiquad}

$Q$ determines amoung other things the amount of peaking the transfer function has at the chosen frequency. @lst-lowPassDifferentQ shows this graphically, the amout of peaking increases with increasing quality factor $Q$.

```{python}
#| label: lst-lowPassDifferentQ
#| fig-cap: "Low pass filter with different quality factors"
#| code-fold: true

# Behavioral Analysis Biquad Filter

import numpy as np
import matplotlib.pyplot as plt

# Initial values
f0 = 1e3  # Resonance frequency in Hz
w0 = 2 * np.pi * f0  # Angular frequency in rad/s
Q1 = 1  # Quality factor
Q2 = 2
Q3 = 5
Q4 = 10
Q5 = 100
H0 = 1  # Play around with this later

# Logarithmic frequency axis
frequencies = np.logspace(2, 4, 10000)  # Frequency from 10^2 to 10^4 Hz
s = 1j * 2 * np.pi * frequencies  # Laplace-Variable s = jÏ‰

############################################
# Transfer functions of Active Filters
############################################

### Numerator
# Low Pass Filter
b_lp = H0

# High Pass Filter
#b_hp = (H0 * (s**2 / w0**2))

# Band Pass Filter
#b_bp = (-H0 * (s / w0))

# Band Stop Filter
#b_bs = -((1 + (s**2 / (w0**2))) * H0)

# Denominator -> for all filters the same
a0 = 1
a1_1 = (s / (w0 * Q1))
a1_2 = (s / (w0 * Q2))
a1_3 = (s / (w0 * Q3))
a1_4 = (s / (w0 * Q4))
a1_5 = (s / (w0 * Q5))
a2 = (s**2 / (w0**2))

den1 = a0 + a1_1 + a2
den2 = a0 + a1_2 + a2
den3 = a0 + a1_3 + a2
den4 = a0 + a1_4 + a2
den5 = a0 + a1_5 + a2

############################################
# Calculation of the transfer functions H(s)
############################################
Hs_lp_1 = b_lp / den1
Hs_lp_2 = b_lp / den2
Hs_lp_3 = b_lp / den3
Hs_lp_4 = b_lp / den4
Hs_lp_5 = b_lp / den5
#Hs_hp = b_hp / den
#Hs_bp = b_bp / den
#Hs_bs = b_bs / den

# Bode Diagram
fig, axs = plt.subplots(2)
#fig.suptitle("frequency response of biquad filter")

# Low Pass Filter
axs[0].semilogx(frequencies, 20 * np.log10(np.abs(Hs_lp_1)), label='$Q = 1$')
axs[1].semilogx(frequencies, np.unwrap(np.angle(Hs_lp_1)) * (180 / np.pi), label='$Q = 1$')
axs[0].semilogx(frequencies, 20 * np.log10(np.abs(Hs_lp_2)), label='$Q = 2$')
axs[1].semilogx(frequencies, np.unwrap(np.angle(Hs_lp_2)) * (180 / np.pi), label='$Q = 2$')
axs[0].semilogx(frequencies, 20 * np.log10(np.abs(Hs_lp_3)), label='$Q = 5$')
axs[1].semilogx(frequencies, np.unwrap(np.angle(Hs_lp_3)) * (180 / np.pi), label='$Q = 5$')
axs[0].semilogx(frequencies, 20 * np.log10(np.abs(Hs_lp_4)), label='$Q = 10$')
axs[1].semilogx(frequencies, np.unwrap(np.angle(Hs_lp_4)) * (180 / np.pi), label='$Q = 10$')
axs[0].semilogx(frequencies, 20 * np.log10(np.abs(Hs_lp_5)), label='$Q = 100$')
axs[1].semilogx(frequencies, np.unwrap(np.angle(Hs_lp_5)) * (180 / np.pi), label='$Q = 100$')
'''
# High Pass Filter
axs[0].semilogx(frequencies, 20 * np.log10(np.abs(Hs_hp)), label='high pass')
axs[1].semilogx(frequencies, np.unwrap(np.angle(Hs_hp)) * (180 / np.pi), label='high pass')

# Band Pass Filter
axs[0].semilogx(frequencies, 20 * np.log10(np.abs(Hs_bp)), label='band pass')
axs[1].semilogx(frequencies, np.unwrap(np.angle(Hs_bp)) * (180 / np.pi), label='band pass')

# Band Stop Filter
axs[0].semilogx(frequencies, 20 * np.log10(np.abs(Hs_bs)), label='band stop')
axs[1].semilogx(frequencies, (np.angle(Hs_bs)) * (180 / np.pi), label='band stop')
'''
#axs[0].title("amplitude response")
axs[0].set_xlabel("frequency/Hz")
axs[0].set_ylabel("amplitude/dB")
#axs[0].set_ylim(-50, 25)
axs[0].grid(True, which="both", ls="--")
axs[0].legend(loc=1)

#axs[1].title("phase response")
axs[1].set_xlabel("frequency/Hz")
axs[1].set_ylabel("phase/deg")
axs[1].grid(True, which="both", ls="--")
axs[1].legend()

plt.tight_layout()
plt.show()
```

The height of the peak can be calculated with:

$$
A_{peak} = \frac{Q}{\sqrt{1 - \frac{1}{4Q^2}}}
$$ {#eq-calculatePeak}

For $Q = 100$ the peak is $A_{peak} = 100.001$, which converted into dB is $A_{peak,dB} = 40\,dB$, as is shown in @fig-lowPassDifferentQ.





## Operational Amplifier
As seen in @fig-BiquadCircuit a Biquad Filter consists four Operational Amplifiers. To get a better understanding of these, this chaper will discuss the main arguments of OPAMS.
There are different types of operational amplifiers that differ, for example, by their low- or high-impedance inputs and outputs. According to Schmid there exist nine diffrent types of the Opamps, but only four are mainly used [@Approximating_OPAMP]. This is because almost always, the non-inverting (positive) input is designed as a high-impedance voltage input. The inverting (negative) input can either be a high-impedance voltage input or a low-impedance current input, depending on the type. Accordingly, the output can be either a low-impedance voltage output or a high-impedance current output. 
This results in four basic configurations, as shown in the accompanying table @tbl-opamp_comapre. (Images are taken from @wiki_opams)


[//]: # Deutsches WIKI https://de.wikipedia.org/wiki/Operationsverst%C3%A4rker#Aufbau_und_Varianten 

|                     | Voltage output                                      | Current output                                           |
|---------------------|---------------------------------------------------------|---------------------------------------------------------|
| **Voltage input** | Voltage-Feedback Amplifiers  												| Operational Transconductance Amplifier         |
|                      | ![OpV_VV](../images/sec_theorectical_background/OpV_VV.png)			| ![OpV_VC](../images/sec_theorectical_background/OpV_VC.png)|
| **Current input**   | Current-Feedback Amplifiers          									| Current Amplifier         |
|                      | ![OpV_CV](../images/sec_theorectical_background/OpV_CV.png)			| ![OpV_CC](../images/sec_theorectical_background/OpV_CC.png)|

: Four typicall Operational Amplifiers {#tbl-opamp_comapre}

::: {.callout-tip}
As a general rule, the simplest circuit that can do a job is usually the best choice. [@hpretlacd]
:::


### Voltage-Feedback Amplifiers (VFA) {#sec-VFA}
When discussing operational amplifiers (OPAMPs), most sources refer to the Voltage-Feedback Amplifier. These VFAs are **voltage-controlled voltage sources**, essentially acting as voltage boosters. They are characterized by a high-impedance input for both the non-inverting and inverting terminals, and a low-impedance voltage output. To realize various desired circuits, such as amplification, integration, addition/subtraction, etc..., these functions should ideally be achieved only through the surrounding circuitry. To meet this requirement, three main requirements need be satisfied:

- **Extremely High Voltage Gain**: Typically ranging from 60 to 120 dB (or gain factor of $10^4$ to $10^6$), this gain should be available over a wide frequency range.
- **High Impedance at Differential Inputs**: Ensuring minimal loading of the signal source.
- **Low Impedance at the Output**: Allowing the amplifier to drive various loads without significant voltage drop.


::: {.callout-tip}
## Difference between a voltage source and a current source 
**Voltage source**  
A voltage source creates a constant voltage output by changing the output. 

**Current source** 
A current source creates a constant current by changing the voltage

Both of this sources can be explained by Ohms-Law: $R = \frac{U}{I}$. For example the voltage source: There is no influence of the load, so $R$ may change and its value is unknown to the source. So to keep the voltage stable we can only change the current.
:::

### Operational Transconductance Amplifier (OTA)
In the design process of the biquad only OTAs will be used, so the focus of this chapter will be on them. The operational transconductance amplifier puts out out a current proportional to its input voltage, unlike Voltage Feedback Amplifiers @sec-VFA. In other words an OTA is a **voltage controlled current source**. 

![Schematic symbol of an OTA @Wangenheim2007](../images/sec_theorectical_background/ota_symbol.png){#fig-otasym}

As seen in the figure @fig-otasym the OTA has the two differental inputs and the current output. On top of that it has a biasing current input $I_{bias}$ which controls the transconductance $g_m$ of the OTA.

#### Transconductance

Transconductance is a fundamental parameter that describes the relationship between the input voltage and the output current in electronic devices, particularly in transistors. It is defined as the ratio of the change in output current to the change in input voltage, under conditions where all other variables are held constant. Mathematically, it is expressed as:

$g_m = \frac{\Delta I_{out}}{\Delta V_{in}}$

where $g_m$ is the transconductance, $\Delta I_{out}$ is the change in output current, and $\Delta V_{in}$ is the change in input voltage. The unit is the siemens S, which is amperes per volt (I/U). In the past *Mho* was used (which is *Ohm* spelled backwards) and it shows the inverse relationship to resistance.

In field-effect transistors (FETs) the transconductance determines the device's ability to amplify signals. A higher transconductance value indicates a stronger amplification capability, as a small change in input voltage can result in a significant change in output current. 

::: {.callout-note}
## Origin of the term transconductance
The term transconductance originates from the concept of **transfer conductance**. It combines the ideas of **transfer**, indicating the transfer of a signal from the input to the output, and **conductance**, which is the inverse of resistance and measures how easily a material conducts electric current. In essence, transconductance describes how effectively a device can convert a voltage change at its input into a proportional current change at its output. @gm_acakids
:::


#### 5-Transistor OTA

@hpretlacd introduces a basic 5-Transistor OTA as a design proposal for a real circuits.

![@hpretlacd 's 5-Transistor OTA](../images/sec_theorectical_background/basic_ota_output.svg){#fig-5tota}

It consists of few elements which are going to be described in the next chapters. The basic function of this OTA can be described with: 
The transistors $M_1$ and $M_2$ form a differential pair, which is biased by the current source $M_5$. Transistors $M_5$ and $M_6$ create a current mirror, where the input bias current $I_{\text{bias}}$ sets the bias current for the Operational Transconductance Amplifier. To keep the biasing current stable a current mirror is used instead of applying the $I_{\text{bias}}$ directly to $M_5$ The differential pair $M_1$ and $M_2$ is loaded by the current mirror $M_3$ and $M_4$, which mirrors the drain current of $M_1$ to the right side of the circuit. The combined currents from $M_4$ and $M_2$ at the output node result in the generation of an output current. To archieve this desired result, it is important to ensure that $M_{1,2}$ and $M_{3,4}$ are symmetric, meaning they should have identical $W$ (width) and $L$ (length) dimensions. To set the right bias current, $M_{5,6}$ should be choosen accordingly.



### Current Mirror

A current mirror consists of at least two transistors, one working as the input (reference) source and the other ones as the replicas of it. As the name suggests, the primary function of a current mirror is to copy the input current to the output, ensuring that the output current is an exact duplicate of the input. Importantly, the flow of the input current is unaffected by the size of the mirrored output current or any variations in it.

This behaviour is made possible by two key characteristics of the current mirror: its relatively low input resistance and its relatively high output resistance. The low input resistance ensures the input current remains stable regardless of drive conditions and the high output resistance maintains a constant output current independent of load variations. @analog_university_current_mirror

![MOSFET Current Mirror (taken from @nerdsdostuff_current_mirror)](../images/sec_theorectical_background/current_mirror.png){#fig-current_mirror width=50%}

A current mirror is also capable of copying one current and convert it to multiple different outputs. This is possible by attaching more transistors with their Gate to the $V_{GS}$ of the reference transistor. By scaling the width and length of each output transistor different, multiple scales of the input current can be created. Hereby a big advantage is when using MOSFETS, due to the fact that no current is flowing through the Gate. In case of BJTs a compensation circuit is added. @hpretlacd

### Differential Pair

A differential pair, also referred to as a differential amplifier, is an electronic circuit designed to compare the difference between two input voltages while minimising any voltage that is common to both inputs. It consists of two transistors and can be differential with has two inputs and two outputs, as seen in @fig-diff_pair. 

![A differential pair @hpretlacd](../images/sec_theorectical_background/differential_pair.svg){#fig-diff_pair}

Common-Mode

Differential voltage

### Variants ?

maybe like miller opamp or something like that


<!-- This is a Comment-->

## MOSFET (Metal-Oxide-Semiconductor Field-Effect-Transistor )

To dive in one more level, the parts an operational amplifier is build of are transistors. Precisely in this design process they are Metal-Oxide-Semiconductor Field-Effect-Transistors (MOSFETs).
In integrated circuit design, where pre-built components are not available, MOSFETs can be designed from scratch. This design flexibility allows for the adjustment of the MOSFET's physical dimensions, specifically its width $W$ and leght $L$. By doing this there is a lot of room for freedom and experimental space. The length $L$ significantly influences MOSFET performance, enabling a trade-off between speed and output conductance. The width $W$ of a MOSFET acts as a scaling factor that adjusts the charge density within the channel, enabling the control of current levels to meet specific design requirements.

::: {.callout-warning}
## Circuit symbol of MOSFETs
In the literature, the circuit symbol of MOSFETs is not uniform. Some denote them with a small arrow between the gate ($G$) and source ($S$), which is not very precise due to the fact that a MOSFET is symmetric. This means that the drain ($D$) and source ($S$) can be interchanged, and the names are only defined to make circuits clearer. Therefore, an accurate symbol for the n-MOS (shown in @fig-nmos) and p-MOS (shown in @fig-pmos) is shown in the following figures taken from @hpretlacd:

![n-MOSFET circuit symbol](../images/sec_theorectical_background/nmos_symbol.svg){#fig-nmos}

![p-MOSFET circuit symbol](../images/sec_theorectical_background/pmos_symbol.svg){#fig-pmos}

However, in this development report, the symbols are not strictly hold like shown here. But all of the used figures are based on this symmetric model of a MOSFET.
Besides this in many situations the bulk $B$ is connnected to the source $S$ terminal. Thus the bulk $B$ is not mentioned in the circuit diagramms. 
:::

### Small-Signal Representation

By applying different voltages to a MOSFET, different behaviours appear. But there is one thing which is very unliked by engineers and others, all these transfer functions are non linear. So making any calculations by hand calculation is nearly impossible. Thats why in practise the biasing method exists. This is done by appying a dc voltage to the terminals of the MOSFET and during operation only a small signal change appears. With this technique an **Operating Point** is created, which enables to assume a linear behavior in its small signal area (like in @fig-mosfetoppoint).

![MOSFET drain current vs. drain-to-source voltage for several values](../images/sec_theorectical_background/mosfet_oppoint.png){#fig-mosfetoppoint}

::: {.callout-important}
## Important variables
- **$I_D$**: The drain current
- **$V_{GS}$**: The gate-to-source voltage
- **$V_{DS}$**: The drain-to-source voltage
- **$V_{th}$**: The threshold voltage. A critical parameter that defines the minimum gate-to-source voltage $V_{GS}$ required to form a conductive channel between the source and drain
- **$g_m$**: The transconductance. The ratio between the output current and input voltage
:::

### MOSFET regions

A MOSFET can operate in three different modes: Saturation, Linear (or Triode) region or Cutoff. The modes depend on the device's threshold voltage $V_{\text{th}}$, gate-to-source voltage $V_{\text{GS}}$, and drain-to-source voltage $V_{\text{DS}}$.

**Saturation** 

The saturation region is the active mode used for analog amplification , where the MOSFET behaves like a voltage-controlled current source . A conductive channel forms between the source and drain. This state is reached when the condition $V_{\text{DS}} \geq (V_{\text{GS}} - V_{\text{th}})$ is met. In saturation, the drain-source current ($I_{\text{DS}}$) stabilizes or "saturates" and becomes nearly independent of $V_{\text{DS}}$. However, it can still be precisely controlled via $V_{\text{GS}}$ due to the phenomenon known as ["pinch-off"](https://en.wikipedia.org/wiki/Channel_length_modulation )


**Linear Region**

The Linear, or Triode, region occurs when a MOSFET is conducting and acts more like a resistor or voltage-controlled device rather than a current source. This region is defined by the condition $V_{\text{DS}} < (V_{\text{GS}} - V_{\text{th}})$ and $V_{\text{GS}} > V_{\text{th}} $. In this mode, both $V_{\text{GS}}$ and $V_{\text{DS}}$ control the $I_{\text{DS}}$, allowing the device to be used effectively for switching and amplification in low-voltage applications. 


**Cutoff Region**

In the Cutoff region, the MOSFET is effectively turned off, with no conductive channel formed between the drain and source. This mode is reached when the gate-to-source voltage is less than the threshold voltage ($V_{\text{GS}} < V_{\text{th}}$). In Cutoff, the drain-source current $I_{\text{DS}}$ is nearly zero, which means the MOSFET is not conducting and behaves like an open switch. 







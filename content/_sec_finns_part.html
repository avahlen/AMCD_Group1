<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.29">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>3&nbsp; Integrated Layouting – IC Design of a Universal Biquad Filter</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../content/_sec_filter-design.html" rel="next">
<link href="../content/_sec_characterisation.html" rel="prev">
<link href="../images/hsb-logo.png" rel="icon" type="image/png">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-0815c480559380816a4d1ea211a47e91.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-e22fbe6e69edb8577f7b7bd0719516f0.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-sidebar floating quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../content/_sec_finns_part.html"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Integrated Layouting</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../">IC Design of a Universal Biquad Filter</a> 
        <div class="sidebar-tools-main tools-wide">
    <a href="https://github.com/avahlen/AMCD_Group1" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
    <div class="dropdown">
      <a href="" title="Download" id="quarto-navigation-tool-dropdown-0" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" role="link" aria-label="Download"><i class="bi bi-download"></i></a>
      <ul class="dropdown-menu" aria-labelledby="quarto-navigation-tool-dropdown-0">
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="../IC-Design-of-a-Universal-Biquad-Filter.pdf">
              <i class="bi bi-file-pdf pe-1"></i>
            Download PDF
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="../IC-Design-of-a-Universal-Biquad-Filter.epub">
              <i class="bi bi-journal pe-1"></i>
            Download ePub
            </a>
          </li>
      </ul>
    </div>
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Abstract</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../content/_sec_introduction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">TOC (only temporary)</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../content/_sec_theoretical_background.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Theoretical Background</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../content/_sec_characterisation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Characterisation</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../content/_sec_finns_part.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Integrated Layouting</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../content/_sec_filter-design.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Filter Design</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../content/_sec_discussion.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Discussion</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../content/_sec_conclusion-outlook.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Conclusion</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../content/references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Bibliography</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#introduction-into-the-fundamentals-of-integrated-layouting." id="toc-introduction-into-the-fundamentals-of-integrated-layouting." class="nav-link active" data-scroll-target="#introduction-into-the-fundamentals-of-integrated-layouting."><span class="header-section-number">3.1</span> Introduction into the fundamentals of integrated layouting.</a></li>
  <li><a href="#klayout" id="toc-klayout" class="nav-link" data-scroll-target="#klayout"><span class="header-section-number">3.2</span> KLayout</a>
  <ul class="collapse">
  <li><a href="#the-setup-of-klayout" id="toc-the-setup-of-klayout" class="nav-link" data-scroll-target="#the-setup-of-klayout"><span class="header-section-number">3.2.1</span> The Setup of KLayout</a></li>
  </ul></li>
  <li><a href="#the-layout-process" id="toc-the-layout-process" class="nav-link" data-scroll-target="#the-layout-process"><span class="header-section-number">3.3</span> The Layout Process</a>
  <ul class="collapse">
  <li><a href="#working-with-lvs-during-layouting" id="toc-working-with-lvs-during-layouting" class="nav-link" data-scroll-target="#working-with-lvs-during-layouting"><span class="header-section-number">3.3.1</span> Working with LVS during layouting</a></li>
  <li><a href="#working-with-drc-during-layouting." id="toc-working-with-drc-during-layouting." class="nav-link" data-scroll-target="#working-with-drc-during-layouting."><span class="header-section-number">3.3.2</span> Working with DRC during layouting.</a></li>
  </ul></li>
  <li><a href="#the-layout-of-the-5t-ota" id="toc-the-layout-of-the-5t-ota" class="nav-link" data-scroll-target="#the-layout-of-the-5t-ota"><span class="header-section-number">3.4</span> The layout of the 5T-OTA</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Integrated Layouting</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>The following chapters describe how to design an integrated circuit using the software KLayout. An introduction and setup for the software will be given as well as some tips and tricks to easier work with the software.</p>
<section id="introduction-into-the-fundamentals-of-integrated-layouting." class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="introduction-into-the-fundamentals-of-integrated-layouting."><span class="header-section-number">3.1</span> Introduction into the fundamentals of integrated layouting.</h2>
<p>Before designing a on the wafer, the basics of the design process must be understood. To that end an explanation of the software as well as the physical layers is necessary to comprehend the design challenges.</p>
<p>When designing an integrated chip, the designer first needs to choose a technology. Each technology has different design rules and properties, which makes it suitable for the application. A technology usually comes with a process design kit (PDK). A PDK contains a device library, verification checks and technology data.</p>
<p>The device library contains the symbols used in the schematic and the PCells/devices used in the layout. The verification checks consist of the design rule check (DRC) as well as the layout vs.&nbsp;schematic (LVS). The technology data represents the basis of DRC and defines the physical constraints of the technology (see <span class="citation" data-cites="PDK_WIKI">Wikipedia contributors (<a href="references.html#ref-PDK_WIKI" role="doc-biblioref">2025</a>)</span>)</p>
<p>The used technology was the sg13g2 technology from IHP. Which is a BiCMOS technology with a 130nm minimum gate length. This PDK is open source and in a preview status (see <span class="citation" data-cites="ihpOpenPDK">IHP‑GmbH (<a href="references.html#ref-ihpOpenPDK" role="doc-biblioref">2025a</a>)</span>)</p>
<p>To design the layout itself one first needs to be familiar with the different masks and the structure of a waver. The following is a simplified explanation of the different layers, their use and the manufacturing process behind it. For this report this is kept simple and will only focus on the layers used in the design. The simplified explenation was heavily inspired by the chapters 2 to 5 in CMOS by Jacaob Baker (see <span class="citation" data-cites="baker2010cmos">Baker (<a href="references.html#ref-baker2010cmos" role="doc-biblioref">2010</a>)</span>).</p>
<p>The base is the bulk and a field oxide (FOX) layer on top of it. In this technology the bulk is a p-substrate. The FOX layer is an insulator, which separates devices from one another.</p>
<p>To make a device first the FOX layer needs to be opened (see <a href="#fig-doping_substrate" class="quarto-xref">Figure&nbsp;<span>3.1</span></a>). That is done by etching away the FOX. The active mask allows the designer to specify the areas where the FOX will be opened. This is necessary for the doping process, which is usually done by an n- or p-select mask. In sg12g2 the n-select mask does not need to be specified. It is necessary to remove the FOX, otherwise the doping specified in the n-select mask will be stopped by the FOX. The select mask also needs to be bigger than the Active mask due to misalignment during the manufacturing process.</p>
<div id="fig-doping_substrate" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-doping_substrate-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="../images/sec_finns_property/image2.png" style="width:6.22505in;height:2.27264in" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-doping_substrate-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.1: Doping process of the substrate
</figcaption>
</figure>
</div>
<p>The next layer is the poly layer. The poly layer forms the gate of the transistors, the name is an abbreviation for Polysilicon. The poly can be routed like normal metal layers, with the exception that it is for more restive than the metal layers, so caution is advised for long poly traces.</p>
<p>In the manufacturing process the thick poly layer prevents the n-select mask to dope the part below the gate, therefore creating the drain and source regions of the nmos (see <a href="#fig-poly_manu" class="quarto-xref">Figure&nbsp;<span>3.2</span></a>).</p>
<div id="fig-poly_manu" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-poly_manu-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="../images/sec_finns_property/image4.png" style="width:4.06736in;height:3.24028in" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-poly_manu-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.2: Figure : Manufacturing the poly layer in the process
</figcaption>
</figure>
</div>
<p>Also note that the drain and source contacts are interchangeable, as they are identical regions in the active area. The last two pictures showed how an NMOS device is formed. As mentioned before, the n-select mask doesn’t exist in the used PDK, but the p-select mask does exist with the label pSD.</p>
<p>As the PMOS is a negated NMOS, the designer first needs to place the p+ regions in an n-substrate. This is done by enveloping the transistor in an NWell. The NWell is a region that can be specified by the designer and works like an implant in the substrate. The FOX is also opened by the active layer but pSD layer is used to implant the p+ region (see <a href="#fig-pmos_manu" class="quarto-xref">Figure&nbsp;<span>3.3</span></a>).</p>
<div id="fig-pmos_manu" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-pmos_manu-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="../images/sec_finns_property/image5.png" style="width:6.92938in;height:2.36599in" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-pmos_manu-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.3: Side view of an PMOS transistor
</figcaption>
</figure>
</div>
<p>The N- or PMOS is formed in the bulk, but there are no electrical connections to the pins of the device. Connections between devices can be established using the poly or active layer, but both options are not advised. Therefore, the first metal layer is used for connections between devices. Connections from an active or poly layer region to the metal layer can´t be made by overlaying the layers as they are separated by an insulator. To connect these different layers the contact layer (Cnt) is used. It connects active or poly layer to the metal 1 layer, by removing the insulator over these regions (see <a href="#fig-metal_connection" class="quarto-xref">Figure&nbsp;<span>3.4</span></a>). Note that the first connection between these regions is always over the metal 1 layer. To switch between the different Metal layers, vias can be used, similar to a multilayer PCB design. These vias are formed by opening the insulator and placing in an conductor like tungsten the opening. In the figure this process is simplied.</p>
<div id="fig-metal_connection" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-metal_connection-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="../images/sec_finns_property/image6.png" style="width:6.10915in;height:3.93131in" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-metal_connection-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.4: Metal connection to the drain and source contacts
</figcaption>
</figure>
</div>
<p>The MOSFET is a 4-pin device, consisting of source, gate, drain and body. While the body often is omitted on a schematic level, in the integrated layout the body of the MOSFET need to be tied to a defined potential. The body is also called the substrate or bulk, in case of a PMOS it is the NWell.</p>
<p>For the nmos this means connecting the substrate to VSS, while the NWell of a PMOS will be pulled to VDD. To have multiple locations to where the bulk or NWell connected to their potentials is advised.</p>
<p>The later chapters will work in the sg13g2 technology, the knowledge acquired in this chapter can be mapped to this technology. The figure (see <a href="#fig-layer_comp" class="quarto-xref">Figure&nbsp;<span>3.5</span></a>) compares the technology on the left, with the learned knowledge on the right. Note that the PWell is not used for NMOS devices only for ties.</p>
<div id="fig-layer_comp" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-layer_comp-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="../images/sec_finns_property/image8.png" style="width:6.98958in;height:1.42674in" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-layer_comp-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.5: ayer comparison between IHP and theory
</figcaption>
</figure>
</div>
</section>
<section id="klayout" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="klayout"><span class="header-section-number">3.2</span> KLayout</h2>
<p>The previous chapter described the fundamentals of the integrated layout, in this chapter these fundamentals are put into practice to create the layout for the 5T-OTA outlined by the schematic by Haraled Pretel(see <span class="citation" data-cites="pretl2025_ota5t_schematic">Pretl et al. (<a href="references.html#ref-pretl2025_ota5t_schematic" role="doc-biblioref">2025</a>)</span>)</p>
<p>The schematic outlined by Professor Pretel consists of 13 N- and PMOS devices. These devices are defined within the PDK and are the fundamental blocks, which make up the layout within the technology. Within the layout software these are defined as PCells. As the schematic designer works out the optimal design, one of the main variables to change the behaviour of the MOSFETs, is the w/l ratio. This ratio defines the width and length of the gate over the active area. These w/l ratios are crucial to the layout process, as they define the physical size of the devices. In the layout the w/l values were given by the calculation of Professor Pretel. These w/l ratios will be used to configure the PCells.</p>
<p>The layout program used is called KLayout. Similar to Xschem it works in a strict hierarchical system. As the layout of the 5T-OTA will be used in the Top-Level layout of the Biquad, the 5T-OTA itself is a cell, that can be called multiple times, throughout the layout of the Top-Level. To make it easier for the designer to connect the individual components of the Top-Level together, the 5T-OTA just uses the metal 1 layer. The interface points are the vias stacks. Therefore, making connections on the higher layers easier, as the individual cells for the 5T-OTA only reside on the most bottom layer.</p>
<p>In the following chapters DRC and LVS will be important concepts. DRC (Desing Rule Check) describes the process of comparing the physical layout to the constrains of the technology. This will throw an error, for example if a “trace” on the Metal1 layer is too thin. LVS (Layout Versus Schematic) describes the process of comparing the schematic to the layout. This will throw an error when two nets are shorted or a device it not correctly connected.</p>
<section id="the-setup-of-klayout" class="level3" data-number="3.2.1">
<h3 data-number="3.2.1" class="anchored" data-anchor-id="the-setup-of-klayout"><span class="header-section-number">3.2.1</span> The Setup of KLayout</h3>
<p>While the previous chapters showed only a cross section of the waver, the designer only sees the waver from a top view, but needs to recall the cross section, while working on the layout. This especially true for the layer that can be used as conductors.</p>
<p>This chapter will explain how to set up KLayout and the tools necessary to run DRC and LVS. It also shows an example way for a simple workflow.</p>
<p>Before the layout process begins it is paramount aggravate all the data files necessary. To do that create a new folder labelled Layout and copy your schematic design into this folder. Consider renaming your schematic into letters only. Do not use special character similar to UNIX symbols, only underscores are permitted.</p>
<p>To create a valid netlist, open the schematic in Xschem. Under <em>simulation-&gt;LVS</em> make sure that “<em>LVS netlist + Top level is a .subckt</em>” and “<em>Upper case .SUBCKT and .ENDS</em>” is selected.<br>
After selecting these options, run the netlist and simulation. In the folder structure a new folder labelled simulations with file named “<em>YOUR_PROJECT.spice</em>” should appear. Copy that file into your main layout directory.</p>
<p>To begin designing create a new layout file called the same as the schematic by running “Klayout -e”. The argument -e opens Klayout in editing mode. To make the editing mode default, select <em>File-&gt;Setup-&gt;Application-&gt;Editing Mode-&gt;Use</em> <em>editing mode by default</em>.</p>
<p>To create a new layout, select “<em>New Layout</em>”. A wizard should appear that allows the selection of the technology. It is important to rename the Top Cell to match the name of your schematic so “YOUR_PROJECT”.<br>
Please note that all the scripts later used are case sensitive, so consider this when renaming files.</p>
<p>Upon first saving, select the GDS file standard and name your file <em>YOUR_PROJECT.GDS</em>. The main layout directory should now contain <em>YOUR_PROJECT.sch/.spice/.gds</em> files. As well as a simulation folder. Now create a folder called LVS in this main layout directory.</p>
<p>For ease of access, create shell-script in your main layout folder to run LVS. The command saved with in the file should be:<br>
</p>
<pre class="shell"><code>python /foss/pdks/ihp-sg13g2/libs.tech/klayout/tech/lvs/run_lvs.py --netlist=YOUR_PROJECT.spice --layout=YOUR_PROJECT.gds --run_dir=LVS/</code></pre>
<p>Try running this command, to ensure it runs correctly. If it fails, saying something about “use_same_circuit”, check the names of your files, including the cell name of your layout. It’s crucial that all files are named the same.</p>
<p>This script will produce a. lvsdb file in the LVS directory. This file contains the comparison between the netlist of the schematic, as well as the extracted netlist of the layout.</p>
<p>As the design process is a constant back and forth with design and running LVS and DRC, these steps are necessary to ensure a good workflow.</p>
<p>Before designing we need to set up the tools in Klayout. For the DRC, open <em>Macros-&gt;Macro Development</em> and select <em>DRC-&gt;[Technology sg13g2]-&gt;sg13g2_maximal</em>. Copy the contents of this script and paste them into a new DRC script. Running this script will provide the “<em>Marker Database Brower</em>” from which the individual DRC errors can be selected. As the error names and a semi-detailed description can be found the “<em>SG13G2_os_layout_rules.pdf</em>” on the Github of IHP (see <span class="citation" data-cites="IHP_SG13G2_layout_rules">IHP‑GmbH (<a href="references.html#ref-IHP_SG13G2_layout_rules" role="doc-biblioref">2025b</a>)</span>).</p>
<p>To run LVS run the shell script and open the netlist browser under <em>Tool-&gt;Netlist Browser</em>. To see the LVS errors click on <em>file-&gt;open</em> and then navigate to <em>/LVS/YOUR_PROJECT.lvsdb</em>. This only needs to be done one time, as the LVS shell script will override the current .lvsdb file, when run anew. Select <em>File-&gt;Reload</em> to get the current LVS-data.</p>
<p>After loading the .lvsdb file the cross-reference tab will show the discrepancies between the netlists. This is because no layout has been created yet.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Some quality-of-life options
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<ul>
<li><p>To provide a better overview of the used layers, right click on the right-hand side layer tab to open a pop up menu and select “<em>hide empty layers</em>”.</p></li>
<li><p>Disabling navigation by holding the middle mouse button: Check <em>File-&gt;Setup-&gt;Navigation-&gt;Zoom and Pan-&gt;Mouse</em> alt mode. This allows the control more similar to Autodesk Fusion or KiCad.</p></li>
<li><p>Disabling the zoom when pasting: <em>File-&gt;Setup-&gt;Navigation-&gt;Zoom</em> and select <em>Pan-&gt;On paste-&gt;Pan to pasted objects.</em> This option disables the full zoom to object, which can cause disorientation.</p></li>
<li><p>To show all the hierarchy and layers select <em>Display-&gt;Full Hierarchy</em></p></li>
<li><p>To change to dark mode select <em>File-&gt;Setup-&gt;Display-&gt;Background-&gt;Background Color-&gt;#42</em></p></li>
</ul>
</div>
</div>
</div>
<p>The real layout process can now begin in Klayout. Different from PCB design, the symbols on the schematic side do not need to be matched to a footprint. Rather the symbol are the fundamental devices in the technology. To work with the devices of the technology open the library on the down-left under <em>Libraries-&gt;SG13_dev</em>. The list below shows the usable devices. By dragging and dropping them into the design, the devices are placed in the layout.</p>
<p>In previous chapters mentioned the w/l ratios will now play a role as the individual devices are configured. To configure a device or PCells, double click it and navigate to PCell parameters and enter the W/L ratios. Updating the PCell will change the device to the desired parameters.</p>
</section>
</section>
<section id="the-layout-process" class="level2" data-number="3.3">
<h2 data-number="3.3" class="anchored" data-anchor-id="the-layout-process"><span class="header-section-number">3.3</span> The Layout Process</h2>
<p>The workflow is much more incremental than in PCB design, as one implements device by device.<br>
To that end, it is practical to copy the original schematic and delete the already placed devices, to maintain an overview of the progress. After every two to three cells, it is advised to run LVS and DRC.</p>
<p>Placing and configuring a device was already described, connecting devices is usually done by the Metal1 layer. It is advised to work with the metal layer alongside the hierarchy. So for the top level use the higher metal layers like Metal3 to Metal6, while for the lower levels use Metal1 to Metal2.</p>
<p>To connect different pins, use the LAYER.drawing layer. Conductors can either be the GatPoly or the Metal layers. Keep in mind that GatPoly.drawing has a higher resistance that Metal.drawing. To switch between the metal layers, use the device called “via_stack” and configure it accordingly.</p>
<p>To connect the gate of a MOS device the GatPoly needs to be connected to Metal1 through the Cnt layer. In contrast to the source and drain contacts this need to be done by hand. See (<a href="#fig-gat_connection" class="quarto-xref">Figure&nbsp;<span>3.6</span></a>) for a DRC clean connection of the gate of an NMOS device.</p>
<div id="fig-gat_connection" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-gat_connection-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="../images/sec_finns_property/image9.png" style="width:4.96736in;height:3.18661in" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-gat_connection-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.6: Example DRC clean connection of the gate
</figcaption>
</figure>
</div>
<p>In general, connect each device separately from each other. It might be tempting to design the layout close together, with overlapping NWells, Active and GatPoly areas, but this will lead to both DRC and LVS errors, which will be difficult to address as each device is close together. This is especially true, when first learning the process.</p>
<p>The layout of the 5T-OTA was done in multiple iterations, each iteration taught valuable lessons. The next section presents these lessons, outlining a specific workflow and offering tips and guidance for beginners.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-3-contents" aria-controls="callout-3" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tips and tricks for the Layout Process.
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-3" class="callout-3-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<ul>
<li><p>Run LVS and DRC every 1 to 3 devices!</p></li>
<li><p>Aligning structures is easier when using a crosshair.<br>
Enable this by checking View-&gt;Crosshair Cursor</p></li>
<li><p>Use the path tool whenever possible.</p>
<ul>
<li><p>The tool has an adjustable width, which can be set on the bottom right menu.</p></li>
<li><p>Set this width to 0.16 um to route DRC free on most layers.</p></li>
<li><p>Do not use free form, as jagged shaped will create DRC errors.</p></li>
</ul></li>
<li><p>Use the shift key to snap to constrain vertically or horizontally.</p></li>
<li><p>To change the layer of structure, select the desired layer, select the structure and press shift+L</p></li>
<li><p>Copying and pasting a structure will result in duplicating the structure in place. Use the move tool to separate both structures.</p></li>
<li><p>If things get too cluttered use the layer menu to declutter the interface.</p>
<ul>
<li><p>Right clicking and selecting “Visibility follows selection” will only show the selected layer.</p></li>
<li><p>Setting different tabs for routing, DRC checking or overviewing the general layout is a good option to keep things tidy and readable</p></li>
<li><p>Changing the appearance of different layers is a good idea, especially for layers that overlap, like pSD or NWell.</p></li>
</ul></li>
<li><p>Use the polygon only on special occasions as it is harder to clear of DRC errors.</p></li>
</ul>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-2-contents" aria-controls="callout-2" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Coming from discrete EDA software
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-2" class="callout-2-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<ul>
<li><p>The devices will not be placed automatically.</p></li>
<li><p>There is no way of changing the grid, as it is defined in technology.</p></li>
<li><p>There is no “Ratsnest” or “Airal Connections”.</p></li>
<li><p>There is no DRC in the background, short circuits will only be caught by running the LVS.</p></li>
<li><p>There is no net highlighting.</p></li>
<li><p>There are no zones, but their absence will cause DRC errors.</p></li>
<li><p>There is no dragging, moving a device always means moving the “traces” by hand with it.</p></li>
<li><p>There are no footprints, the PCells are the fundamental footprints defined by the technology.</p></li>
<li><p>Text size can’t be set but will adjust to the zoom level.</p></li>
<li><p>The GUI is sometimes not working, especially true for LVS.</p></li>
</ul>
</div>
</div>
</div>
</div>
</div>
</div>
<section id="working-with-lvs-during-layouting" class="level3" data-number="3.3.1">
<h3 data-number="3.3.1" class="anchored" data-anchor-id="working-with-lvs-during-layouting"><span class="header-section-number">3.3.1</span> Working with LVS during layouting</h3>
<p>The Netlist Database Browser will provide an overview of all the nets both in the layout and the schematic or “Reference”. Each net has a number in brackets behind it. This number describes all the pins it is connected to. The netlists will only then match if these numbers are matched.</p>
<p>During the layout process it is paramount to use the LAYER.text layers and the text tool to assign labels to the GatPoly or Metal1 layers. To select these layers, one may need to show all layers under Layer-&gt;Show all. To keep the comparison in the netlist browser simple, name the nets of the layout according to the names of the nets in the schematic. Please refer to the designer’s etiquette, while labeling the layout or schematic (see <span class="citation" data-cites="pretl2025">Pretl, Koefinger, and Dorrer (<a href="references.html#ref-pretl2025" role="doc-biblioref">2025</a>)</span>).</p>
<p>When working out the LVS it is advised to check mainly the devices in the list. This will provide a comprehensive overview of the devices, and the nets connected to them. Running LVS and DRC frequently will help with the overview.</p>
<p>It is normal that even the correctly wired devices are shown as errors. Especially the drain and source pins often swap places, which can’t be fixed by rotating the device. To clear the errors all nets connected to the device need to be cleared first. Only when all nets are correctly connected, will the device be clear of errors.</p>
<p>Having two nets on the same pit is always short circuit and should be handled with the highest priory.</p>
<p>After a few MOS devices are placed, LVS will throw an error as their body “pin” is not connected to a defined potential. In an prior chapter the process of tying down the substrate was already explained. In this technology the substrate is a p-substrate, this means the NWells need to be tied down and there must be multiple tying down points for the p-substrate (see <a href="#fig-tiedown" class="quarto-xref">Figure&nbsp;<span>3.7</span></a>). Please note that the size of the masks shown has been altered for visibility reasons. Also note that each PMOS needs its own tie to the VDD potential, while the ties for the NMOS can be placed anywhere on the layout, as the substrate is the bulk.</p>
<div id="fig-tiedown" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-tiedown-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="../images/sec_finns_property/image11.png" style="width:6.12245in;height:3.12569in" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-tiedown-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.7: Tying down different types of bulks contacts. Not to scale.
</figcaption>
</figure>
</div>
<p>While using the netlist browser allows also for a rudimentary net highlighting in the layout. The practicality depends on the number of devices connected to the net. In general troubleshooting get more difficult, the more pins are connected to the same net.</p>
</section>
<section id="working-with-drc-during-layouting." class="level3" data-number="3.3.2">
<h3 data-number="3.3.2" class="anchored" data-anchor-id="working-with-drc-during-layouting."><span class="header-section-number">3.3.2</span> Working with DRC during layouting.</h3>
<p>Running the DRC often and addressing them as soon as possible, allows for a denser and generally more compact layout. It also reduces the time spend reworking the layout after all devices have been connected.</p>
<p>As described in set up chapter the “Marker Database Browser” is a built-in tool for addressing DRC errors. This tool shows the amount of DRC errors as well as the type. After following the steps described in the setup, one can open the Brower under Tool-&gt;Marker Browser. And running the DRC by selecting the run button.</p>
<p>The DRC will categorise in cells. Opening the DRC error log up will show the name of the error. Names link to the “<em>SG13G2_os_layout_rules.pdf</em>” by IHP. While KLayout also provides a description of the errors, it is best to use the DRC in conjunction with the DRC-PDF. The DRC-PDF provides context and dimensions for each error.</p>
<p>Working dually with the DRC-PDF and the DRC-Browser, allows the user to first clarify the DRC errors and than locate it by selecting it in the browser.</p>
<p>A very useful tool to clear DRC errors is the “partial” tool in the toolbar. This allows to modify structures after they are placed. This speed up the workflow immensely as the structures don’t need to redrawn.</p>
<p>Some DRC errors can’t be fixed at a given point of the design process. These DRC errors are usually due to density errors. But as the layout is not fully completed, cleaning these DRC errors has at best no impact on the design. Nevertheless, these errors must be cleared before the tape out.</p>
</section>
</section>
<section id="the-layout-of-the-5t-ota" class="level2" data-number="3.4">
<h2 data-number="3.4" class="anchored" data-anchor-id="the-layout-of-the-5t-ota"><span class="header-section-number">3.4</span> The layout of the 5T-OTA</h2>
<p>To design the 5T-OTA the schematic and the values of Professor Pretel were used (see <span class="citation" data-cites="pretl2025_ota5t_schematic">Pretl et al. (<a href="references.html#ref-pretl2025_ota5t_schematic" role="doc-biblioref">2025</a>)</span>).</p>
<p>As the export functionality of KLayout is rather limited, it is best to open the .gds file in KLayout directly, but the is also a SVG in the layout folder.</p>
<p>While not very space efficient the layout followed the location of the MOSFETS in the schematic to ensure readability. This helped during the layout process, as it gave a clear structure to the layout. This also benefitted the understanding of the LVS and DRC during the layout immensely.</p>
<p>As space is one of main drivers of cost in IC design, a final version should be more mindful of the space used by the devices and traces. This would also clear the density errors, due to a higher density, because of the more compact design.</p>
<p>The design features multiple NWell and PWell Ties, to ensure that both bulks and NWell are connected to their potentials. Each PMOS-device has and NWell tie, which is closely located to the device. The PWell ties surround the design, as described in the introductory chapter to the integrated layout, the bulk shares one potential, but it is good practice to not use a star formation, to ensure this potential is evenly distributed.</p>
<p>One of the design goals of the design is the connection only on the first metal layer, this should ensure that the connection layers above are not influenced by the design. In addition, it provides a clear connection point for the top-level schematic.</p>
<p>The 5T-OTA.gds could easily be imported as cell into an arbitrary top- or mid-level design. Which concludes the design goal of this report.</p>


<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list" style="display: none">
<div id="ref-baker2010cmos" class="csl-entry" role="listitem">
Baker, R. Jacob. 2010. <em>CMOS: Circuit Design, Layout, and Simulation</em>. 3rd ed. IEEE Press / Wiley.
</div>
<div id="ref-ihpOpenPDK" class="csl-entry" role="listitem">
IHP‑GmbH. 2025a. <span>“IHP Open‑source PDK: 130 Nm BiCMOS (SG13G2) Open Source Process Design Kit.”</span> <a href="https://github.com/IHP-GmbH/IHP-Open-PDK" class="uri">https://github.com/IHP-GmbH/IHP-Open-PDK</a>.
</div>
<div id="ref-IHP_SG13G2_layout_rules" class="csl-entry" role="listitem">
———. 2025b. <span>“SG13G2_open‑source_layout_rules.pdf.”</span> <a href="https://github.com/IHP‑GmbH/IHP‑Open‑PDK/blob/main/ihp‑sg13g2/libs.doc/doc/SG13G2_os_layout_rules.pdf" class="uri">https://github.com/IHP‑GmbH/IHP‑Open‑PDK/blob/main/ihp‑sg13g2/libs.doc/doc/SG13G2_os_layout_rules.pdf</a>.
</div>
<div id="ref-pretl2025" class="csl-entry" role="listitem">
Pretl, Harald, Michael Koefinger, and Simon Dorrer. 2025. <span>“Analog <span>Circuit</span> <span>Design</span>.”</span> <a href="https://doi.org/10.5281/zenodo.14387481">https://doi.org/10.5281/zenodo.14387481</a>.
</div>
<div id="ref-pretl2025_ota5t_schematic" class="csl-entry" role="listitem">
Pretl, Harald, Michael Koefinger, Simon Dorrer, and IIC‑JKU. 2025. <span>“Ota‑5t.svg – 5‑transistor OTA Schematic from the Analog Circuit Design Course.”</span> <a href="https://github.com/iic-jku/analog-circuit-design/blob/main/xschem/ota-5t.svg" class="uri">https://github.com/iic-jku/analog-circuit-design/blob/main/xschem/ota-5t.svg</a>.
</div>
<div id="ref-PDK_WIKI" class="csl-entry" role="listitem">
Wikipedia contributors. 2025. <span>“Process Design Kit.”</span> <a href="https://de.wikipedia.org/wiki/Process_Design_Kit" class="uri">https://de.wikipedia.org/wiki/Process_Design_Kit</a>.
</div>
</div>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/avahlen\.github\.io\/AMCD_Group1\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../content/_sec_characterisation.html" class="pagination-link" aria-label="Characterisation">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Characterisation</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../content/_sec_filter-design.html" class="pagination-link" aria-label="Filter Design">
        <span class="nav-page-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Filter Design</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




</body></html>